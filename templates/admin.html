{% extends "layout.html" %}

{% block title %}Admin Control Center - Food Bank Management System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2 mb-0">Admin Control Center</h1>
        <p class="lead">Manage system operations and settings</p>
    </div>
    <div class="col-md-4 text-md-end">
        <div class="btn-group">
            <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary">
                <i class="fas fa-users-cog me-2"></i>User Management
            </a>
            <a href="{{ url_for('admin') }}#metrics" class="btn btn-outline-primary">
                <i class="fas fa-chart-line me-2"></i>Analytics
            </a>
        </div>
    </div>
</div>

<!-- Admin Control Center Module with 5-button pattern -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-danger bg-opacity-25">
                <h2 class="h4 mb-0"><i class="fas fa-cogs me-2"></i>Admin Control Center</h2>
            </div>
            <div class="card-body">
                <div class="row module-buttons-container">
                    <div class="col-md-4 col-lg module-button-wrapper mb-3">
                        <a href="{{ url_for('admin_users') }}" class="text-decoration-none">
                            <div class="module-button shadow-sm border">
                                <i class="fas fa-users-cog"></i>
                                <h5>User Management</h5>
                                <p class="small mb-0">Manage accounts</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 col-lg module-button-wrapper mb-3">
                        <div class="module-button shadow-sm border">
                            <i class="fas fa-sliders-h"></i>
                            <h5>System Configuration</h5>
                            <p class="small mb-0">Customize settings</p>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg module-button-wrapper mb-3">
                        <a href="#approval-queue" class="text-decoration-none">
                            <div class="module-button shadow-sm border">
                                <i class="fas fa-clipboard-check"></i>
                                <h5>Approval Queue</h5>
                                <p class="small mb-0">Process requests</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 col-lg module-button-wrapper mb-3">
                        <a href="#metrics" class="text-decoration-none">
                            <div class="module-button shadow-sm border">
                                <i class="fas fa-chart-line"></i>
                                <h5>Analytics Dashboard</h5>
                                <p class="small mb-0">View metrics</p>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-4 col-lg module-button-wrapper mb-3">
                        <div class="module-button shadow-sm border">
                            <i class="fas fa-file-export"></i>
                            <h5>Export Data</h5>
                            <p class="small mb-0">Generate reports</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Statistics -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="h5 mb-0">System Overview</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-users"></i>
                            <h3>{{ stats.total_users }}</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-success bg-opacity-10 text-success">
                            <i class="fas fa-boxes"></i>
                            <h3>{{ stats.total_inventory_quantity }}</h3>
                            <p>Items in Inventory</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-donate"></i>
                            <h3>{{ stats.total_donations }}</h3>
                            <p>Total Donations</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-info bg-opacity-10 text-info">
                            <i class="fas fa-hands-helping"></i>
                            <h3>{{ stats.total_requests }}</h3>
                            <p>Total Requests</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-secondary bg-opacity-10 text-secondary">
                            <i class="fas fa-user-friends"></i>
                            <h3>{{ stats.total_volunteers }}</h3>
                            <p>Volunteers</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-danger bg-opacity-10 text-danger">
                            <i class="fas fa-building"></i>
                            <h3>{{ stats.total_partners }}</h3>
                            <p>Partner Organizations</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-secondary bg-opacity-10 text-secondary">
                            <i class="fas fa-map-marker-alt"></i>
                            <h3>{{ stats.total_food_banks }}</h3>
                            <p>Food Bank Locations</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="dashboard-stat bg-success bg-opacity-10 text-success">
                            <i class="fas fa-clock"></i>
                            <h3>{{ stats.total_volunteer_hours }}</h3>
                            <p>Volunteer Hours</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Queue -->
<div class="row mb-5" id="approval-queue">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="h5 mb-0">Approval Queue</h3>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="approvalTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="donations-tab" data-bs-toggle="tab" data-bs-target="#donations-tab-pane" type="button" role="tab" aria-controls="donations-tab-pane" aria-selected="true">
                            Donations <span class="badge bg-danger ms-1">{{ stats.pending_donations }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests-tab-pane" type="button" role="tab" aria-controls="requests-tab-pane" aria-selected="false">
                            Food Requests <span class="badge bg-danger ms-1">{{ stats.pending_requests }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="volunteers-tab" data-bs-toggle="tab" data-bs-target="#volunteers-tab-pane" type="button" role="tab" aria-controls="volunteers-tab-pane" aria-selected="false">
                            Volunteer Hours
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="approvalTabsContent">
                    <!-- Donations Tab -->
                    <div class="tab-pane fade show active" id="donations-tab-pane" role="tabpanel" aria-labelledby="donations-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Donor</th>
                                        <th>Type</th>
                                        <th>Amount/Items</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if pending_donations %}
                                        {% for donation in pending_donations %}
                                        <tr>
                                            <td>{{ donation.created_at.strftime('%Y-%m-%d') if donation.created_at else 'N/A' }}</td>
                                            <td>{{ donation.donor.username if donation.donor else 'Unknown' }}</td>
                                            <td>{{ donation.donation_type.capitalize() }}</td>
                                            <td>
                                                {% if donation.donation_type == 'money' %}
                                                    ${{ '%.2f'|format(donation.amount) if donation.amount else '0.00' }}
                                                {% else %}
                                                    {{ donation.amount if donation.amount else 'N/A' }}
                                                {% endif %}
                                            </td>
                                            <td><span class="status-badge status-pending">{{ donation.status }}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('view_donation', donation_id=donation.id) }}" class="btn btn-outline-primary"><i class="fas fa-eye"></i></a>
                                                    <form method="POST" action="{{ url_for('approve_donation', donation_id=donation.id) }}" style="display:inline;">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-outline-success"><i class="fas fa-check"></i></button>
                                                    </form>
                                                    <button class="btn btn-outline-danger" disabled><i class="fas fa-times"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No pending donations found</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Food Requests Tab -->
                    <div class="tab-pane fade" id="requests-tab-pane" role="tabpanel" aria-labelledby="requests-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Beneficiary</th>
                                        <th>Household Size</th>
                                        <th>Emergency</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if pending_requests %}
                                        {% for request in pending_requests %}
                                        <tr>
                                            <td>{{ request.created_at.strftime('%Y-%m-%d') if request.created_at else 'N/A' }}</td>
                                            <td>{{ request.beneficiary.username if request.beneficiary else 'Unknown' }}</td>
                                            <td>{{ request.household_size }}</td>
                                            <td>
                                                {% if request.emergency %}
                                                    <span class="badge bg-danger">Yes</span>
                                                {% else %}
                                                    No
                                                {% endif %}
                                            </td>
                                            <td><span class="status-badge status-pending">{{ request.status }}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('view_request', request_id=request.id) }}" class="btn btn-outline-primary"><i class="fas fa-eye"></i></a>
                                                    <form method="POST" action="{{ url_for('approve_request', request_id=request.id) }}" style="display:inline;">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-outline-success"><i class="fas fa-check"></i></button>
                                                    </form>
                                                    <button class="btn btn-outline-danger" disabled><i class="fas fa-times"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No pending requests found</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Volunteer Hours Tab -->
                    <div class="tab-pane fade" id="volunteers-tab-pane" role="tabpanel" aria-labelledby="volunteers-tab" tabindex="0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Volunteer</th>
                                        <th>Role</th>
                                        <th>Hours Logged</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if unverified_volunteer_hours %}
                                        {% for slot in unverified_volunteer_hours %}
                                        <tr>
                                            <td>{{ slot.date.strftime('%Y-%m-%d') if slot.date else 'N/A' }}</td>
                                            <td>{{ slot.volunteer.username if slot.volunteer else 'Unknown' }}</td>
                                            <td>{{ slot.role }}</td>
                                            <td>{{ slot.hours_logged }} hours</td>
                                            <td><span class="badge bg-warning text-dark">Unverified</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <form method="POST" action="{{ url_for('verify_volunteer_hours', slot_id=slot.id) }}" style="display:inline;">
                                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                        <button type="submit" class="btn btn-outline-success"><i class="fas fa-check"></i> Verify</button>
                                                    </form>
                                                    <button class="btn btn-outline-danger" disabled><i class="fas fa-times"></i> Reject</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No volunteer hours for verification</td>
                                    </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Metrics -->
<div class="row mb-5" id="metrics">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="h5 mb-0">Analytics Dashboard</h3>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">User Statistics</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="userChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Inventory by Category</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="inventoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Monthly Donations</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="donationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Request Status</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="requestChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Links -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="h5 mb-0">Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary d-block py-3">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            Manage Users
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('add_food_bank') }}" class="btn btn-outline-primary d-block py-3">
                            <i class="fas fa-plus-circle fa-2x mb-2"></i><br>
                            Add Food Bank
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('inventory') }}" class="btn btn-outline-primary d-block py-3">
                            <i class="fas fa-boxes fa-2x mb-2"></i><br>
                            Manage Inventory
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('create_distribution') }}" class="btn btn-outline-primary d-block py-3">
                            <i class="fas fa-truck fa-2x mb-2"></i><br>
                            Create Distribution
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load the approval queue data via AJAX
        
        // Initialize charts
        initializeCharts();
    });
    
   
    
    function initializeCharts() {
        // User Statistics Chart
        const userCtx = document.getElementById('userChart');
        if (userCtx) {
            new Chart(userCtx, {
                type: 'pie',
                data: {
                    labels: ['Donors', 'Beneficiaries', 'Volunteers', 'Partners', 'Admins'],
                    datasets: [{
                        data: [
                            {{ stats.total_donors }},
                            {{ stats.total_beneficiaries }},
                            {{ stats.total_volunteers }},
                            {{ stats.total_partners }},
                            {{ stats.total_users - stats.total_donors - stats.total_beneficiaries - stats.total_volunteers - stats.total_partners }}
                        ],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'User Distribution by Role'
                        }
                    }
                }
            });
        }
        
        // Inventory Chart - This is just a placeholder, real data would come from the server
        const inventoryCtx = document.getElementById('inventoryChart');
        if (inventoryCtx) {
            new Chart(inventoryCtx, {
                type: 'bar',
                data: {
                    labels: ['Canned Goods', 'Dry Goods', 'Fresh Produce', 'Dairy', 'Protein', 'Beverages', 'Other'],
                    datasets: [{
                        label: 'Items in Stock',
                        data: [300, 250, 150, 100, 200, 175, 125],
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Inventory by Category'
                        }
                    }
                }
            });
        }
        
        // Donation Chart
        const donationCtx = document.getElementById('donationChart');
        if (donationCtx) {
            new Chart(donationCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Donations',
                        data: [65, 59, 80, 81, 56, 55, 40, 45, 50, 55, 60, 70],
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Donation Trends'
                        }
                    }
                }
            });
        }
        
        // Request Chart
        const requestCtx = document.getElementById('requestChart');
        if (requestCtx) {
            new Chart(requestCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Approved', 'Fulfilled', 'Declined'],
                    datasets: [{
                        data: [
                            {{ stats.pending_requests }},
                            {{ stats.total_requests - stats.pending_requests }}/3,
                            {{ stats.total_requests - stats.pending_requests }}/3*2,
                            {{ stats.total_requests - stats.pending_requests }}/3
                        ],
                        backgroundColor: [
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Food Requests by Status'
                        }
                    }
                }
            });
        }
    }
</script>
{% endblock %}
{% endblock %}
